name: Secure Key Rotation with MFA
on:
  schedule:
    - cron: "0 0 1 */3 *"  # æ¯å­£åº¦é¦–æ—¥åˆå¤œè¿è¡Œ
  workflow_dispatch:        # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      force:
        description: 'å¼ºåˆ¶è½®æ¢(è·³è¿‡éªŒè¯)'
        required: false
        default: 'false'

jobs:
  rotate-keys:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    env:
      VAULT_ADDR: ${{ secrets.VAULT_ADDR }}
      VAULT_TOKEN: ${{ secrets.VAULT_TOKEN }}
      SLACK_WEBHOOK: ${{ secrets.SLACK_SECURITY_WEBHOOK }}
      FORCE_ROTATION: ${{ github.event.inputs.force }}
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python with logging
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          
      - name: Install security tools
        run: |
          echo "::group::å®‰è£…å®‰å…¨å·¥å…·"
          sudo apt-get update
          sudo apt-get install -y vault jq curl gnupg
          pip install cryptography==45.0.5
          echo "::endgroup::"

      - name: Rotate keys with MFA verification
        run: |
          echo "::group::å®‰å…¨å¯†é’¥è½®æ¢æµç¨‹"
          set -e
          
          # åˆå§‹åŒ–æ—¥å¿—å’Œä¸´æ—¶ç›®å½•
          TIMESTAMP=$(date +%Y%m%d%H%M%S)
          LOG_FILE="key_rotation_$TIMESTAMP.log"
          TEMP_DIR="key_rotation_$TIMESTAMP"
          mkdir -p $TEMP_DIR
          
          echo "Key Rotation Log - $(date)" > $LOG_FILE
          echo "å·¥ä½œç›®å½•: $(pwd)" >> $LOG_FILE
          
          # 1. æ£€æŸ¥å¯†é’¥å¹´é¾„
          echo "[$(date)] æ£€æŸ¥å¯†é’¥å¹´é¾„..." | tee -a $LOG_FILE
          KEY_AGE=$(vault kv get -field=age secret/api_keys/current || echo "0")
          if [ $KEY_AGE -lt 90 ] && [ "$FORCE_ROTATION" = "false" ]; then
            echo "å¯†é’¥æœªè¾¾åˆ°90å¤©æœ€å°ä½¿ç”¨æœŸé™ï¼Œè·³è¿‡è½®æ¢" | tee -a $LOG_FILE
            exit 0
          fi
          
          # 2. å¤šå› ç´ è®¤è¯éªŒè¯
          echo "[$(date)] å¼€å§‹MFAéªŒè¯..." | tee -a $LOG_FILE
          if [ "$FORCE_ROTATION" = "false" ]; then
            if ! python tools/verify_mfa.py; then
              echo "::error::MFAéªŒè¯å¤±è´¥" | tee -a $LOG_FILE
              exit 1
            fi
            echo "MFAéªŒè¯é€šè¿‡" | tee -a $LOG_FILE
          else
            echo "âš ï¸ è·³è¿‡MFAéªŒè¯ (å¼ºåˆ¶æ¨¡å¼)" | tee -a $LOG_FILE
          fi
          
          # 3. å¤‡ä»½å½“å‰å¯†é’¥
          echo "[$(date)] å¤‡ä»½å½“å‰å¯†é’¥..." | tee -a $LOG_FILE
          CURRENT_KEY=$(vault kv get -field=value secret/api_keys/current)
          echo $CURRENT_KEY > $TEMP_DIR/current_key.bak
          gpg --encrypt --recipient security-team@example.com $TEMP_DIR/current_key.bak
          
          # 4. ç”Ÿæˆæ–°å¯†é’¥å¹¶éªŒè¯
          echo "[$(date)] ç”Ÿæˆæ–°å¯†é’¥..." | tee -a $LOG_FILE
          NEW_KEY=$(openssl rand -hex 32)
          echo $NEW_KEY > $TEMP_DIR/new_key.tmp
          gpg --encrypt --recipient security-team@example.com $TEMP_DIR/new_key.tmp
          
          # 5. æµ‹è¯•æ–°å¯†é’¥
          echo "[$(date)] æµ‹è¯•æ–°å¯†é’¥..." | tee -a $LOG_FILE
          if [ "$FORCE_ROTATION" = "false" ]; then
            if ! python tools/test_reddit_api.py --key=$NEW_KEY; then
              echo "::error::æ–°å¯†é’¥éªŒè¯å¤±è´¥" | tee -a $LOG_FILE
              exit 1
            fi
            echo "æ–°å¯†é’¥éªŒè¯é€šè¿‡" | tee -a $LOG_FILE
          else
            echo "âš ï¸ è·³è¿‡å¯†é’¥éªŒè¯ (å¼ºåˆ¶æ¨¡å¼)" | tee -a $LOG_FILE
          fi
          
          # 6. æ›´æ–°ç³»ç»Ÿé…ç½® (é¢„æ£€)
          echo "[$(date)] æ›´æ–°ç³»ç»Ÿé…ç½®(é¢„æ£€)..." | tee -a $LOG_FILE
          if ! python tools/update_services.py --key=$NEW_KEY --dry-run; then
            echo "::error::æœåŠ¡é…ç½®é¢„æ£€å¤±è´¥" | tee -a $LOG_FILE
            exit 1
          fi
          
          # 7. æ‰§è¡Œæ­£å¼è½®æ¢
          echo "[$(date)] æ‰§è¡Œæ­£å¼è½®æ¢..." | tee -a $LOG_FILE
          vault kv put secret/api_keys/current value=$NEW_KEY age=0 || {
            echo "::error::å¯†é’¥æ›´æ–°å¤±è´¥" | tee -a $LOG_FILE
            exit 1
          }
          
          # 8. å½’æ¡£æ—§å¯†é’¥
          echo "[$(date)] å½’æ¡£æ—§å¯†é’¥..." | tee -a $LOG_FILE
          vault kv put secret/api_keys/old value=$CURRENT_KEY status=revoked || {
            echo "::warning::æ—§å¯†é’¥å½’æ¡£å¤±è´¥ï¼Œä½†æ–°å¯†é’¥å·²ç”Ÿæ•ˆ" | tee -a $LOG_FILE
          }
          
          # 9. å®Œæˆéƒ¨ç½²
          echo "[$(date)] å®Œæˆéƒ¨ç½²..." | tee -a $LOG_FILE
          if ! python tools/update_services.py --key=$NEW_KEY; then
            echo "::error::æœåŠ¡é…ç½®æ›´æ–°å¤±è´¥ï¼Œæ‰§è¡Œå›æ»š" | tee -a $LOG_FILE
            
            # å›æ»šæµç¨‹
            echo "[$(date)] å¼€å§‹å›æ»š..." | tee -a $LOG_FILE
            vault kv put secret/api_keys/current value=$CURRENT_KEY age=$KEY_AGE || {
              echo "::error::å›æ»šå¤±è´¥ï¼Œéœ€è¦æ‰‹åŠ¨å¹²é¢„" | tee -a $LOG_FILE
              exit 1
            }
            
            # æ¢å¤æœåŠ¡é…ç½®
            python tools/update_services.py --key=$CURRENT_KEY || {
              echo "::error::æœåŠ¡é…ç½®æ¢å¤å¤±è´¥" | tee -a $LOG_FILE
              exit 1
            }
            
            exit 1
          fi
          
          # 10. æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          echo "[$(date)] æ¸…ç†ä¸´æ—¶æ–‡ä»¶..." | tee -a $LOG_FILE
          shred -u $TEMP_DIR/*.tmp $TEMP_DIR/*.bak
          
          echo "[$(date)] å¯†é’¥è½®æ¢æˆåŠŸå®Œæˆ" | tee -a $LOG_FILE
          echo "::endgroup::"

      - name: Upload security artifacts
        uses: actions/upload-artifact@v4
        with:
          name: key-rotation-${{ github.run_id }}
          path: |
            key_rotation_*.log
            key_rotation_*/*.gpg
            
      - name: Notify rotation status with details
        if: always()
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const { WebClient } = require('@slack/web-api');
            const slack = new WebClient(process.env.SLACK_WEBHOOK);
            
            try {
              // è¯»å–æ—¥å¿—æ–‡ä»¶
              const logFiles = fs.readdirSync('.').filter(f => f.startsWith('key_rotation_'));
              const latestLog = logFiles.length > 0 ? 
                fs.readFileSync(logFiles[logFiles.length - 1], 'utf8') : 'æ— æ—¥å¿—æ–‡ä»¶';
              
              // æå–å…³é”®äº‹ä»¶
              const events = {
                mfa: latestLog.includes('MFAéªŒè¯é€šè¿‡') ? 'âœ…' : (latestLog.includes('è·³è¿‡MFAéªŒè¯') ? 'âš ï¸' : 'âŒ'),
                keyGen: latestLog.includes('ç”Ÿæˆæ–°å¯†é’¥') ? 'âœ…' : 'âŒ',
                keyTest: latestLog.includes('æ–°å¯†é’¥éªŒè¯é€šè¿‡') ? 'âœ…' : (latestLog.includes('è·³è¿‡å¯†é’¥éªŒè¯') ? 'âš ï¸' : 'âŒ'),
                rotation: latestLog.includes('æ‰§è¡Œæ­£å¼è½®æ¢') ? 'âœ…' : 'âŒ',
                rollback: latestLog.includes('å¼€å§‹å›æ»š') ? 'ğŸ”„' : 'â–'
              };
              
              // GitHubé€šçŸ¥
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `å¯†é’¥è½®æ¢${process.env.GITHUB_JOB_STATUS === 'success' ? 'æˆåŠŸ âœ…' : 'å¤±è´¥ âŒ'}\n` +
                      `å¼ºåˆ¶æ¨¡å¼: ${process.env.FORCE_ROTATION === 'true' ? 'æ˜¯ âš ï¸' : 'å¦'}\n` +
                      `å…³é”®æ­¥éª¤:\n` +
                      `- MFAéªŒè¯: ${events.mfa}\n` +
                      `- å¯†é’¥ç”Ÿæˆ: ${events.keyGen}\n` +
                      `- å¯†é’¥æµ‹è¯•: ${events.keyTest}\n` +
                      `- æ­£å¼è½®æ¢: ${events.rotation}\n` +
                      `- å›æ»šæ“ä½œ: ${events.rollback}\n\n` +
                      `è¯¦æƒ…: ${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID}`
              });
              
              // Slacké€šçŸ¥
              await slack.chat.postMessage({
                channel: '#security',
                text: `å¯†é’¥è½®æ¢${process.env.GITHUB_JOB_STATUS === 'success' ? 'æˆåŠŸ' : 'å¤±è´¥'}`,
                blocks: [
                  {
                    type: 'header',
                    text: {
                      type: 'plain_text',
                      text: `å¯†é’¥è½®æ¢ ${process.env.GITHUB_JOB_STATUS === 'success' ? 'æˆåŠŸ' : 'å¤±è´¥'}`,
                      emoji: true
                    }
                  },
                  {
                    type: 'section',
                    fields: [
                      {
                        type: 'mrkdwn',
                        text: `*æ¨¡å¼*: ${process.env.FORCE_ROTATION === 'true' ? 'å¼ºåˆ¶ âš ï¸' : 'æ ‡å‡†'}`
                      },
                      {
                        type: 'mrkdwn',
                        text: `*MFAéªŒè¯*: ${events.mfa}`
                      }
                    ]
                  },
                  {
                    type: 'section',
                    fields: [
                      {
                        type: 'mrkdwn',
                        text: `*å¯†é’¥ç”Ÿæˆ*: ${events.keyGen}`
                      },
                      {
                        type: 'mrkdwn',
                        text: `*å¯†é’¥æµ‹è¯•*: ${events.keyTest}`
                      }
                    ]
                  },
                  {
                    type: 'section',
                    fields: [
                      {
                        type: 'mrkdwn',
                        text: `*æ­£å¼è½®æ¢*: ${events.rotation}`
                      },
                      {
                        type: 'mrkdwn',
                        text: `*å›æ»šæ“ä½œ*: ${events.rollback}`
                      }
                    ]
                  },
                  {
                    type: 'actions',
                    elements: [
                      {
                        type: 'button',
                        text: {
                          type: 'plain_text',
                          text: 'æŸ¥çœ‹è¯¦æƒ…'
                        },
                        url: `${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID}`
                      }
                    ]
                  }
                ]
              });
            } catch (e) {
              console.error('é€šçŸ¥å‘é€å¤±è´¥:', e);
            }