name: Quarterly Key Rotation
on:
  schedule:
    - cron: "0 0 1 */3 *"  # æ¯å­£åº¦é¦–æ—¥åˆå¤œè¿è¡Œ
  workflow_dispatch:        # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  rotate-keys:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          
      - name: Install Vault CLI
        run: |
          sudo apt-get update
          sudo apt-get install -y vault
          
      - name: Rotate API Keys
        env:
          VAULT_ADDR: ${{ secrets.VAULT_ADDR }}
          VAULT_TOKEN: ${{ secrets.VAULT_TOKEN }}
        run: |
          # 1. ç”Ÿæˆæ–°å¯†é’¥
          NEW_KEY=$(vault kv get -field=value secret/api_keys/new)
          
          # 2. æ›´æ–°ç³»ç»Ÿé…ç½®
          vault kv put secret/api_keys/current value=$NEW_KEY
          
          # 3. å½’æ¡£æ—§å¯†é’¥
          vault kv put secret/api_keys/old value=$(vault kv get -field=value secret/api_keys/current)
          
          # 4. éªŒè¯æœåŠ¡è¿æ¥
          python tools/test_reddit_api.py --key=$NEW_KEY
          
      - name: Notify team
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'ğŸ”‘ å­£åº¦å¯†é’¥è½®æ¢å·²å®Œæˆï¼Œæ–°å¯†é’¥å·²éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ'
            })