name: Quarterly Key Rotation
on:
  schedule:
    - cron: "0 0 1 */3 *"  # æ¯å­£åº¦é¦–æ—¥åˆå¤œè¿è¡Œ
  workflow_dispatch:        # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  rotate-keys:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          
      - name: Install Vault CLI
        run: |
          sudo apt-get update
          sudo apt-get install -y vault
          
      - name: Rotate API Keys
        env:
          VAULT_ADDR: ${{ secrets.VAULT_ADDR }}
          VAULT_TOKEN: ${{ secrets.VAULT_TOKEN }}
        run: |
          # 1. æ£€æŸ¥å¯†é’¥æ˜¯å¦è¿‡æœŸ
          KEY_AGE=$(vault kv get -field=age secret/api_keys/current)
          if [ $KEY_AGE -lt 90 ]; then
            echo "å¯†é’¥æœªè¾¾åˆ°90å¤©æœ€å°ä½¿ç”¨æœŸé™ï¼Œè·³è¿‡è½®æ¢"
            exit 0
          fi
          
          # 2. å®¡è®¡å¯†é’¥ä½¿ç”¨æƒ…å†µ
          vault read -format=json sys/audit | jq -r '.data.paths' > audit_logs.json
          python tools/analyze_key_usage.py audit_logs.json
          
          # 3. ç”Ÿæˆæ–°å¯†é’¥
          NEW_KEY=$(vault kv get -field=value secret/api_keys/new)
          
          # 4. æ›´æ–°ç³»ç»Ÿé…ç½®
          vault kv put secret/api_keys/current value=$NEW_KEY age=0
          
          # 5. å½’æ¡£æ—§å¯†é’¥å¹¶æ ‡è®°ä¸ºå·²æ’¤é”€
          vault kv put secret/api_keys/old value=$(vault kv get -field=value secret/api_keys/current) status=revoked
          
          # 6. éªŒè¯æœåŠ¡è¿æ¥
          python tools/test_reddit_api.py --key=$NEW_KEY || exit 1
          
          # 7. æ›´æ–°æ‰€æœ‰æœåŠ¡é…ç½®
          python tools/update_services.py --key=$NEW_KEY
          
      - name: Notify team
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'ğŸ”‘ å­£åº¦å¯†é’¥è½®æ¢å·²å®Œæˆï¼Œæ–°å¯†é’¥å·²éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ'
            })